<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Résultats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.6/dist/simple-statistics.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            font-size: 0.9em;
        }

        .container {
            width: 65%;
            min-width: 500px;
            max-width: 2000px;
            margin: 0 auto;
            padding: 18px;
        }

        h1 {
            text-align: center;
            margin-bottom: 18px;
            font-size: 1.8em;
            color: #555;
        }

        button {
            margin: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 7px;
            text-align: center;
            font-size: 0.9em;
        }

        table th {
            background-color: #f2f2f2;
        }

        canvas {
            margin: 18px 0;
        }

        .chart-container {
            margin: 18px 0;
        }

        .collapsible {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            cursor: pointer;
        }

        .collapsible-content {
            display: none;
            margin-top: 10px;
        }

        .link-input-container {
            display: flex;
            margin-bottom: 5px;
            align-items: center;
        }

        .link-input-container input {
            flex: 1;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="results-title">Résultats</h1>

        <!-- Collapsible pour ajouter des liens -->
        <div class="collapsible" onclick="toggleCollapsible()">Ajouter des liens</div>
        <div class="collapsible-content">
            <div id="links-container"></div>
            <button onclick="addLinkInput()">+</button>
        </div>

        <!-- Bouton Calculer -->
        <button onclick="fetchResultsFromLinks()">Calculer</button>

        <!-- Conteneur pour les tableaux -->
        <div id="tables-container"></div>

        <!-- Conteneur pour les graphiques -->
        <div id="charts-container"></div>
        <div id="chartsContainer"></div>
    </div>

    <script>
        let isCollapsibleOpen = false;
        const chartsContainer = document.getElementById('chartsContainer');

        function toggleCollapsible() {
            isCollapsibleOpen = !isCollapsibleOpen;
            document.querySelector('.collapsible-content').style.display = isCollapsibleOpen ? 'block' : 'none';
        }

        function addLinkInput() {
            const container = document.getElementById('links-container');
            const inputContainer = document.createElement('div');
            inputContainer.classList.add('link-input-container');
            inputContainer.innerHTML = `
                <input type="text" placeholder="Lien vers les résultats">
                <button onclick="removeLinkInput(this)">-</button>
            `;
            container.appendChild(inputContainer);
        }

        function removeLinkInput(button) {
            button.parentElement.remove();
        }

        async function fetchResultsFromLinks() {
            const links = [...document.querySelectorAll('#links-container input')]
                .map(input => input.value.trim())
                .filter(link => link);

            if (links.length === 0) {
                const currentUrl = window.location.href;
                const params = new URLSearchParams(new URL(currentUrl).search);
                if (Array.from(params.keys()).length > 0) {
                    links.push(currentUrl);
                } else {
                    alert("Aucun lien n'a été fourni, et aucun paramètre n'est présent dans l'URL actuelle.");
                    return;
                }
            }

            const results = [];
            for (const link of links) {
                const url = new URL(link);
                const params = new URLSearchParams(url.search);

                const motors = params.get('motors') ? JSON.parse(decodeURIComponent(params.get('motors'))) : [];
                const visuals = params.get('visuals') ? JSON.parse(decodeURIComponent(params.get('visuals'))) : [];
                const speed = params.get('speed') || 'Inconnu';
                results.push({ motors, visuals, speed });
            }

            if (results.length === 1) { // Un seul lien
                const speed = results[0].speed;
                document.getElementById('results-title').textContent = `Résultats (condition ${speed})`;
                displaySingleResults(results[0]);
            } else { // Plusieurs liens
                document.getElementById('results-title').textContent = 'Résultats';
                displayComparisonResults(results);
                console.log(results);
            }
        }

        function displaySingleResults(data) {
            const tablesContainer = document.getElementById('tables-container');
            const chartsContainer = document.getElementById('charts-container');
            tablesContainer.innerHTML = '';
            chartsContainer.innerHTML = '';

            const createTable = (title, data) => {
                const calculateStdDev = (values) => {
                    const mean = values.reduce((sum, value) => sum + value, 0) / values.length;
                    const squaredDiffs = values.map(value => Math.pow(value - mean, 2));
                    const meanSquaredDiff = squaredDiffs.reduce((sum, value) => sum + value, 0) / values.length;
                    return Math.sqrt(meanSquaredDiff);
                };

                const stdDev = calculateStdDev(data.map(time => time / 1000)); // Conversion des millisecondes en secondes

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Temps Réel (s)</th>
                            <th>Temps Estimé (s)</th>
                            <th>Différence (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((time, index) => `
                            <tr>
                                <td>${title} ${index + 1}</td>
                                <td>${(time / 1000).toFixed(2)}</td>
                                <td>${(30000 / 1000).toFixed(2)}</td>
                                <td>${((time - 30000) / 1000).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                        <tr>
                            <td colspan="3"><strong>Écart type (Temps Réel)</strong></td>
                            <td><strong>${stdDev.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                `;
                tablesContainer.appendChild(table);
            };

            createTable('Moteur', data.motors);
            createTable('Visuel', data.visuals);

            createLineChart('Temps Moteurs', data.motors.map(x => x / 1000), chartsContainer);
            createLineChart('Temps Visuels', data.visuals.map(x => x / 1000), chartsContainer);
            createDoubleLineChart(data.motors.map(x => x / 1000), data.visuals.map(x => x / 1000), chartsContainer);
        }

        function createLineChart(title, data, container) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => `Essai ${i + 1}`),
                    datasets: [{
                        label: title,
                        data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function createDoubleLineChart(motor, visuals, container) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: motor.map((_, i) => `Essai ${i + 1}`),
                    datasets: [
                        {
                        label: "Moteur",
                        data: motor,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false
                    },
                    {
                        label: "Visuel",
                        data: visuals,
                        borderColor: 'rgb(192, 75, 75)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false
                    }
                ]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function displayComparisonResults(results) {
            const tablesContainer = document.getElementById('tables-container');
            const chartsContainer = document.getElementById('charts-container');
            tablesContainer.innerHTML = '';
            chartsContainer.innerHTML = '';

            const averages = results.reduce((acc, { motors, visuals, speed }) => {
                const motorAvg = motors.reduce((a, b) => a + b, 0) / motors.length;
                const visualAvg = visuals.reduce((a, b) => a + b, 0) / visuals.length;
                acc[speed] = acc[speed] || { motors: [], visuals: [] };
                acc[speed].motors.push(motorAvg);
                acc[speed].visuals.push(visualAvg);
                return acc;
            }, {});

            const createConditionTable = (data) => {
                const table = document.createElement('table');
                table.classList.add('styled-table');

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headerRow.innerHTML = `
                    <th>Condition</th>
                    <th>Visuel (s)</th>
                    <th>Moteur (s)</th>
                `;

                const tbody = table.createTBody();
                Object.entries(data).forEach(([speed, times]) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${speed.charAt(0).toUpperCase() + speed.slice(1)}</td>
                        <td>${(times.visuals[0] / 1000).toFixed(2)}</td>
                        <td>${(times.motors[0] / 1000).toFixed(2)}</td>
                    `;
                });

                return table;
            };

            const createComparisonTable = (data) => {
                const table = document.createElement('table');
                table.classList.add('styled-table');

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headerRow.innerHTML = `
                    <th>Condition</th>
                    <th>Rapide (s)</th>
                    <th>Lente (s)</th>
                `;

                const tbody = table.createTBody();
                ['visuals', 'motors'].forEach((key) => {
                    const row = tbody.insertRow();

                    const rapideValue = data.rapide && data.rapide[key] ? data.rapide[key][0] / 1000 : 'Données manquantes';
                    const lenteValue = data.lente && data.lente[key] ? data.lente[key][0] / 1000 : 'Données manquantes';

                    row.innerHTML = `
                        <td>${key === 'motors' ? 'Moteur' : 'Visuel'}</td>
                        <td>${typeof rapideValue === 'number' ? rapideValue.toFixed(2) : rapideValue}</td>
                        <td>${typeof lenteValue === 'number' ? lenteValue.toFixed(2) : lenteValue}</td>
                    `;
                });

                return table;
            };

            const createMinMaxTable = (data) => {
                const table = document.createElement('table');
                table.classList.add('styled-table');

                // Création de l'en-tête
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headerRow.innerHTML = `
                    <th></th>
                    <th>Moteur (s)</th>
                    <th>Visuel (s)</th>
                    <th>Rapide (s)</th>
                    <th>Lent (s)</th>
                `;

                // Corps du tableau
                const tbody = table.createTBody();

                // Fonction pour calculer min et max combinés pour des tableaux
                const calculateCombinedMinMax = (arrays) => {
                    const combinedArray = arrays.flat(); // Fusionner les tableaux en un seul
                    return {
                        min: Math.min(...combinedArray),
                        max: Math.max(...combinedArray),
                    };
                };

                // Rassembler les données par type et par vitesse
                const groupedData = {
                    motors: [],
                    visuals: [],
                    rapide: [],
                    lente: []
                };

                // Trier les données dynamiquement dans groupedData
                data.forEach((item) => {
                    groupedData.motors.push(...item.motors);
                    groupedData.visuals.push(...item.visuals);
                    if (item.speed === 'rapide') {
                        groupedData.rapide.push(...item.motors, ...item.visuals);
                    } else if (item.speed === 'lente') {
                        groupedData.lente.push(...item.motors, ...item.visuals);
                    }
                });

                // Calcul des min et max pour chaque catégorie
                const minMaxData = {
                    motors: calculateCombinedMinMax([groupedData.motors]),
                    visuals: calculateCombinedMinMax([groupedData.visuals]),
                    rapide: calculateCombinedMinMax([groupedData.rapide]),
                    lente: calculateCombinedMinMax([groupedData.lente]),
                };

                // Ajouter la ligne des minima
                const minRow = tbody.insertRow();
                minRow.innerHTML = `
                    <td><strong>Min</strong></td>
                    <td>${minMaxData.motors.min/1000}</td>
                    <td>${minMaxData.visuals.min/1000}</td>
                    <td>${minMaxData.rapide.min/1000}</td>
                    <td>${minMaxData.lente.min/1000}</td>
                `;

                // Ajouter la ligne des maxima
                const maxRow = tbody.insertRow();
                maxRow.innerHTML = `
                    <td><strong>Max</strong></td>
                    <td>${minMaxData.motors.max/1000}</td>
                    <td>${minMaxData.visuals.max/1000}</td>
                    <td>${minMaxData.rapide.max/1000}</td>
                    <td>${minMaxData.lente.max/1000}</td>
                `;

                return table;
            };

            const createStdDevTable = (data) => {
                const table = document.createElement('table');
                table.classList.add('styled-table');

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headerRow.innerHTML = `
                    <th></th>
                    <th>Moteur</th>
                    <th>Visuel</th>
                    <th>Rapide</th>
                    <th>Lent</th>
                `;

                const tbody = table.createTBody();

                // Fonction pour calculer l'écart type
                const calculateStdDev = (array) => {
                    const mean = array.reduce((acc, val) => acc + val, 0) / array.length;
                    const variance = array.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / array.length;
                    return Math.sqrt(variance);
                };

                const groupedData = {
                    motors: [],
                    visuals: [],
                    rapide: [],
                    lente: []
                };

                data.forEach(item => {
                    groupedData.motors.push(...item.motors);
                    groupedData.visuals.push(...item.visuals);
                    if (item.speed === 'rapide') {
                        groupedData.rapide.push(...item.motors, ...item.visuals);
                    } else if (item.speed === 'lente') {
                        groupedData.lente.push(...item.motors, ...item.visuals);
                    }
                });

                const stdDevData = {
                    motors: calculateStdDev(groupedData.motors),
                    visuals: calculateStdDev(groupedData.visuals),
                    rapide: calculateStdDev(groupedData.rapide),
                    lente: calculateStdDev(groupedData.lente),
                };

                const stdDevRow = tbody.insertRow();
                stdDevRow.innerHTML = `
                    <td><strong>Écart type</strong></td>
                    <td>${(stdDevData.motors/1000).toFixed(2)}</td>
                    <td>${(stdDevData.visuals/1000).toFixed(2)}</td>
                    <td>${(stdDevData.rapide/1000).toFixed(2)}</td>
                    <td>${(stdDevData.lente/1000).toFixed(2)}</td>
                `;

                return table;
            };


            const conditionTable = createConditionTable(averages);
            const comparisonTable = createComparisonTable(averages);
            const comparisonMinMax = createMinMaxTable(results);
            const comparisonStdDev = createStdDevTable(results);
            tablesContainer.appendChild(conditionTable);
            tablesContainer.appendChild(comparisonTable);
            tablesContainer.appendChild(comparisonMinMax);
            tablesContainer.appendChild(comparisonStdDev);

            const createLineChart = (type, data) => {
                const ctx = document.createElement('canvas');
                chartsContainer.appendChild(ctx);

                const labels = [];
                const motorsData = [];
                const visualsData = [];

                Object.entries(data).forEach(([speed, times]) => {
                    if (times && Array.isArray(times.motors) && Array.isArray(times.visuals)) {
                        const averageMotors = times.motors.reduce((a, b) => a + b, 0) / times.motors.length;
                        const averageVisuals = times.visuals.reduce((a, b) => a + b, 0) / times.visuals.length;

                        labels.push(speed);
                        motorsData.push(averageMotors / 1000);
                        visualsData.push(averageVisuals / 1000);
                    } else {
                        console.error(`Invalid data for speed "${speed}":`, times);
                    }
                });

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Moteur (s)',
                                data: motorsData,
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0, 0, 255, 0.1)',
                                fill: false
                            },
                            {
                                label: 'Visuel (s)',
                                data: visualsData,
                                borderColor: 'green',
                                backgroundColor: 'rgba(0, 255, 0, 0.1)',
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Comparaison des Moyennes des Temps (${type})`
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temps (s)'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            createLineChart('Comparaison des Conditions', averages);
        }


        document.addEventListener("DOMContentLoaded", fetchResultsFromLinks);

    </script>
</body>
</html>
