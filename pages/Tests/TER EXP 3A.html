<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exp.</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.18.0/js/md5.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("OSoGqXrFMqxl9Miuk");
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            max-width: 600px;
            width: 100%;
        }

        .container3 {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        .container2 {
            position: absolute; 
            left: 0; 
            right: 0; 
            margin-inline: auto; 
            width: fit-content;
            top: 50%;
            transform: translateY(-50%);
        }

        .container4 {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #experiment-screen {
            height: 150px;
        }

        input, button {
            padding: 10px;
            margin-top: 10px;
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        button {
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        #minute-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            max-width: 300px;
        }

        /* Grille invisible pour le test 1 */
        .grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .grid div {
            width: 100%;
            height: 100%;
        }

        .circle {
            width: 125px;
            height: 125px;
            background-color: black;
            border-radius: 50%;
            position: absolute;
            visibility: hidden;
        }

        /* Canvas pour dessiner le trait de la souris */
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1; /* Derrière tout le reste */
        }

        #experiment-video {
            position: absolute; 
            left: 0; 
            right: 0; 
            margin-inline: auto; 
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            height: 100%;
        }

        .loader {
            --color: #a5a5b0;
            --size: 70px;
            width: var(--size);
            height: var(--size);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .loader span {
            width: 100%;
            height: 100%;
            background-color: var(--color);
            animation: keyframes-blink 0.6s alternate infinite linear;
        }

        .loader span:nth-child(1) {
            animation-delay: 0ms;
        }

        .loader span:nth-child(2) {
            animation-delay: 200ms;
        }

        .loader span:nth-child(3) {
            animation-delay: 300ms;
        }

        .loader span:nth-child(4) {
            animation-delay: 400ms;
        }

        .loader span:nth-child(5) {
            animation-delay: 500ms;
        }

        .loader span:nth-child(6) {
            animation-delay: 600ms;
        }

        @keyframes keyframes-blink {
            0% {
                opacity: 0.3;
                transform: scale(0.5) rotate(5deg);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .container-form {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .container-form h1 {
            text-align: center;
            color: #4CAF50;
        }
        .question {
            margin: 20px 0;
        }
        .container-form label {
            font-size: 16px;
            display: block;
            margin-bottom: 5px;
        }
        .options {
            display: flex;
            gap: 20px;
        }
        .options label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .options input {
            margin-right: 10px;
        }
        .container-form .btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .container-form .alert {
            color: red;
            text-align: center;
            margin-top: 20px;
        }

        #message_container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        #number-display {
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .number-container {
            display: flex;
            gap: 10px;
        }

        .number-box {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-size: 18px;
            font-weight: bold;
            border: solid 1px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #next-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #next-button:hover {
            background-color: #218838;
        }

        .input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-input {
            width: 50px;
            height: 50px;
            font-size: 16px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .number-input:focus {
            outline: none;
            border-color: #007BFF;
        }
    </style>
</head>
<body>
    <!-- Canvas pour dessiner le trait de la souris -->
    <canvas id="drawing-canvas"></canvas>
    
    <div class="container3" id="welcome-screen">
        <h1>Bienvenue dans cette expérience</h1>
        <p style="margin: 20px; font-size: larger;">Veuillez entrer le code de votre test :</p>
        <input type="text" id="test-code" style="font-size: larger;" placeholder="Entrez le numéro du test">
        <button onclick="startTest()" style="font-size: larger;">Commencer</button>
    </div>

    <div class="container3 hidden" id="first_condition">
        <h1>Consentement</h1>
        <p style="margin: 20px; font-size: larger;">Avant de commencer ce questionnaire, veuillez lire attentivement les informations suivantes :</p>
        <p style="margin: 20px; font-size: medium;">
            Ce questionnaire est anonyme et les données recueillies seront utilisées uniquement dans le cadre de cette expérience.
            Vous êtes libre de participer ou non, et vous pouvez arrêter à tout moment sans avoir à vous justifier.
            En répondant à ce questionnaire, vous acceptez de participer volontairement à cette étude.
            Souhaitez-vous continuer et donner votre consentement ?
        </p>

        <button onclick="conditions(true)" style="font-size: larger;">Oui, je donne mon consentement.</button>
        <button onclick="conditions(false)" style="font-size: larger;">Non, je ne souhaite pas participer.</button>
    </div>

    <!-- Condition Acceptation -->
    <div class="container3 hidden" id="condition-screen">
        <h1 id="condition-title">Conditions</h2>
        <p id="condition-text" style="font-size: larger;"></p>
        <label style="color: rgb(223, 41, 41);" id="condition-text-label">
            <input type="checkbox" id="accept-conditions" style="font-size: larger;"> J'accepte les conditions.
        </label>
        <button id="start-experiment" onclick="launchExperiment()" style="font-size: larger;" disabled>Lancer l'expérience</button>
    </div>

    <!-- Ecran de l'expérience -->
    <div class="container3 hidden" id="experiment-screen">
        <p id="trial-number-training" style="font-size: xx-large; margin-top: 15px; color: red;" class="hidden">(ENTRAÎNEMENT)</p>
        <p id="trial-number" style="font-size: xx-large; margin-top: 10px;"></p>
        <!-- Grille pour le test 1 -->
        <div class="grid hidden" id="circle-grid">
            <div></div> <!-- 100 cells will be created dynamically -->
        </div>
        <div class="circle" id="circle"></div>

        <!-- Ajout de la vidéo pour les essais du test 3 -->
        <video id="experiment-video" class="hidden"></video>
    </div>

    <div class="container2" style="text-align: center; font-size: x-large;">
        <p id="countdown" class="hidden" style="font-size: 42px;">Préparez-vous...</p>
        <div class="loader">
            <span class="load-spinner hidden"></span>
            <span class="load-spinner hidden"></span>
            <span class="load-spinner hidden"></span>
            <span class="load-spinner hidden"></span>
            <span class="load-spinner hidden"></span>
            <span class="load-spinner hidden"></span>
        </div>    
    </div>

    <!-- Questionnaire -->
    <div class="container-form hidden" id="form-qt">
        <h1>Questionnaire</h1>
        <form id="questionnaireForm">
            <div class="question" id="gender_question">
                <label>Quel est votre genre ?</label>
                <div class="options">
                    <label><input type="radio" name="q5" value="Homme">Homme</label>
                    <label><input type="radio" name="q5" value="Femme">Femme</label>
                    <label><input type="radio" name="q5" value="Autre">Autre</label>
                </div>
            </div>
            <div class="question">
                <label>Quel est votre âge ?</label>
                <div class="options">
                    <label><input type="number" id="age_question" name="q6" min="18"></label>
                </div>
            </div>
            <div class="question">
                <label>Avez-vous des troubles de la vue importants ?</label>
                <div class="options">
                    <label><input type="radio" name="q1" value="1" class="toggle-input" data-target="q1-details"> Oui</label>
                    <label><input type="radio" name="q1" value="0" class="toggle-input" data-target="q1-details"> Non</label>
                </div>
                <div id="q1-details" class="details hidden">
                    <label>Précisez :</label>
                    <input type="text" name="q1-details-input" id="trouble1" placeholder="Exemples : très mauvaise vue même avec des lunettes, vision partielle, strabisme important, etc.">
                </div>
            </div>
            <div class="question">
                <label>Avez-vous des troubles qui peuvent influencer votre façon de voir ou de bouger ?</label>
                <div class="options">
                    <label><input type="radio" name="q2" value="1" class="toggle-input" data-target="q2-details"> Oui</label>
                    <label><input type="radio" name="q2" value="0" class="toggle-input" data-target="q2-details"> Non</label>
                </div>
                <div id="q2-details" class="details hidden">
                    <label>Précisez :</label>
                    <input type="text" name="q2-details-input" id="trouble2" placeholder="Exemples : trouble de l’attention (TDAH), difficultés d’apprentissage, etc.">
                </div>
            </div>
            <button type="button" class="btn" onclick="submitForm()">Soumettre</button>
        </form>
        <p id="alertMessage" class="alert"></p>
    </div>

    <div class="container hidden" id="message_container">
        <div id="messsage_bf_condition" style="font-size: large; margin-bottom: 15px;"></div>
        <button type="button" class="btn hidden" id="message_btn" onclick="validateMessage()" style="font-size: large;">Confirmer</button>
    </div>

    <div class="container4 hidden" id="number-display">
        <span style="margin-bottom: 40px;">Retenez les chiffres suivants, ils vous seront demandés à la fin de la première partie.</span>
        <div class="number-container">
            <!-- Les nombres seront générés ici -->
        </div>
        <button id="next-button" onclick="validateNumbers()">Suite</button>
    </div>

    <div class="container4 hidden" id="input-container">
        <h3>Veuillez rappeler les chiffres de la liste à mémoriser.</h3>
        <div class="input-container">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
            <input type="number" class="number-input">
        </div>
        <button id="next-button" onclick="validateInputs()">Valider</button>
    </div>
    
    <!-- Bouton "Je pense que ça fait 30 secondes" -->
    <button id="minute-button" class="hidden" onclick="endTrial()" style="font-size: larger;">Je pense que ça fait 30 secondes</button>

    <script>
        let currentTest = null;
        let trial = 1;  // Essai actuel
        let motorTrials = 12;
        let visualTrials = 12;
        let testTrials = 3; // Nombre d'essais d'entraînement
        let VtestTrials = 3; // Nombre d'essais d'entraînement
        let maxTrials = motorTrials + visualTrials + testTrials + VtestTrials;  // Maximum d'essais
        let trialDurations = [];
        let trialStartTime;
        let trialEndTime;
        let countdownTimer;
        let trialTimer;
        let betweenTrialsTimer;
        let videoIndex = 0;
        let expOrder = [];
        let visualDone = 0;
        let motorDone = 0;
        const numberContainer = document.querySelector('.number-container');
        let videoTrial = false;
        let videos = [
            '../../videos/tests/ter/exp/rapide1.mp4',
            '../../videos/tests/ter/exp/rapide2.mp4',
            '../../videos/tests/ter/exp/rapide3.mp4',
            '../../videos/tests/ter/exp/rapide4.mp4',
            '../../videos/tests/ter/exp/rapide5.mp4',
            '../../videos/tests/ter/exp/rapide6.mp4',
            '../../videos/tests/ter/exp/rapide7.mp4',
            '../../videos/tests/ter/exp/rapide8.mp4',
            '../../videos/tests/ter/exp/rapide9.mp4',
            '../../videos/tests/ter/exp/rapide10.mp4',
            '../../videos/tests/ter/exp/rapide11.mp4',
            '../../videos/tests/ter/exp/rapide12.mp4',
            '../../videos/tests/ter/exp/rapide13.mp4',
            '../../videos/tests/ter/exp/rapide14.mp4',
            '../../videos/tests/ter/exp/rapide15.mp4'
        ];

        let videosLentes = [
            '../../videos/tests/ter/exp/lent1.mp4',
            '../../videos/tests/ter/exp/lent2.mp4',
            '../../videos/tests/ter/exp/lent3.mp4',
            '../../videos/tests/ter/exp/lent4.mp4',
            '../../videos/tests/ter/exp/lent5.mp4',
            '../../videos/tests/ter/exp/lent6.mp4',
            '../../videos/tests/ter/exp/lent7.mp4',
            '../../videos/tests/ter/exp/lent8.mp4',
            '../../videos/tests/ter/exp/lent9.mp4',
            '../../videos/tests/ter/exp/lent10.mp4',
            '../../videos/tests/ter/exp/lent11.mp4',
            '../../videos/tests/ter/exp/lent12.mp4',
            '../../videos/tests/ter/exp/lent13.mp4',
            '../../videos/tests/ter/exp/lent14.mp4',
            '../../videos/tests/ter/exp/lent15.mp4'
        ];

        const codes1 = ["4", "6", "7", "8", "1", "2", "9"];
        const codes2 = ["8", "1", "2", "9", "4", "6", "7"];
        const participantsLents = [
            {"pass": "c569106554fab26ec9bfd1c2bac0026e", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "3ccab13151283ac8319f8227b6fc371f", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "718c97066b84fbda905ebec987f1a15d", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "35f0a2e0640fb54912a7cae046c38afa", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "11f73087c3111e92cbb69fbb64a51a6b", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "a79206cdd2ab64edf2f4d82852d4c721", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "cf4786dbe0c5364c9f7bd35cc4361fb2", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "b88122f1416f72a3520dd80a39c54f98", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "95c412d277eaa29cb623cfed90510987", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "4c6c65ec8e29d30ff929deec96aa283f", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "89ac3e398a2741e8faeeaf65478452e2", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "45cac0b0b14ff5b97e19e76e717efb42", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "9639828edde5e997f76354ba8b2d143a", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "48d56e4fced14d48ed2b1f251e91cc86", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "43edd7281886951680b32718bc540011", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1}
        ];
        const lent = participantsLents.map(item => item.pass);
        const participantsRapides = [
            {"pass": "2ece41bc13c5c7579a2e29b94fce8ede", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "3e1a4dddb02a6d483d80b794af8b527c", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "db41f791a0bb17f3c2f1a591a5aa710b", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "b110493be3614b85ebc520972389d33a", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "090da94e827106cfb4ad9969ab11cad5", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "f46af3aa92d2798c60372306121117bd", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "0db4d0eedb7c90d402897ec3a07b622e", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "f4df54b579e3e92584edb2ea903d6a63", "MOVF": "motor", "MOVN": "visual", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "95d684a8e8aa7b27954dffd830531f44", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "6d659da8b9b23a880e4960190d6a03d3", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "dfa19597e975cdad79d54577d66a1c43", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "c17f9224d9a2c39d31f70d9637d23285", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes1, "codeToGive2" : codes2},
            {"pass": "ec3476293f5c6f0480b17478d5aa90ba", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "6a34a3ea2ed5262157368358adaff132", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1},
            {"pass": "fdc8a4a1493908ac2fb940424e5e51a9", "MOVF": "visual", "MOVN": "motor", "codeToGive1" : codes2, "codeToGive2" : codes1}
        ];
        const rapide = participantsRapides.map(item => item.pass);
        let participant = -1;

        let lastMouseX = null;
        let lastMouseY = null;
        let lastMouseTime = null;

        // Élément d'alerte rouge
        const alertDiv = document.createElement('div');
        alertDiv.innerText = "Ne bougez pas trop vite votre souris dans cette condition !";
        alertDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: red;
            color: white;
            text-align: center;
            padding: 10px;
            display: none; /* Caché par défaut */
            z-index: 1000;
        `;
        document.body.appendChild(alertDiv);
        
        let isDrawing = false; // Variable pour déterminer si le dessin est activé
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');

        // Ajuster la taille du canvas
        canvas.width = window.screen.width;
        canvas.height = window.screen.height;

        function shuffle(array) {
            if (array.length === 2) {
                // Randomly decide whether to swap the two elements
                if (Math.random() < 0.5) {
                    [array[0], array[1]] = [array[1], array[0]];
                }
            }
            return array;
        }

        function displayNumbers(numbers) {
            numbers.forEach(number => {
                const numberBox = document.createElement('div');
                numberBox.className = 'number-box';
                numberBox.textContent = number;
                numberContainer.appendChild(numberBox);
            });
        }

        function eraseNumbers() {
            numberContainer.innerHTML = "";
        }

        function startTest() {
            const testCode = md5(document.getElementById('test-code').value);

            if(rapide.indexOf(testCode) != -1) {
                currentTest = "1";
                participant = participantsRapides[rapide.indexOf(testCode)];
            } else if(lent.indexOf(testCode) != -1) {
                currentTest = "2";
                participant = participantsLents[lent.indexOf(testCode)];
            }

            if (currentTest != null && !localStorage.getItem("user_test_code")) {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('first_condition').classList.remove('hidden');
            } else {
                alert("Numéro de test invalide, vous avez déjà participé ou votre participation a été révoquée.");
            }
        }

        document.querySelectorAll('.toggle-input').forEach((input) => {
            input.addEventListener('change', (event) => {
                const targetId = event.target.getAttribute('data-target');
                const detailsElement = document.getElementById(targetId);

                if (event.target.value === "1" && event.target.checked) {
                    detailsElement.classList.remove('hidden');
                } else {
                    detailsElement.classList.add('hidden');
                }
            });
        });

        function conditions(accept) {
            if(accept) {
                document.getElementById('first_condition').classList.add('hidden');
                document.getElementById('form-qt').classList.remove('hidden');
            } else {
                alert("Merci de votre réponse.")
                location.reload();
            }
        }

        function submitForm() {
            const form = document.getElementById('questionnaireForm');
            const alertMessage = document.getElementById('alertMessage');
            const age_question = document.getElementById('age_question');
            alertMessage.textContent = ""; // Clear previous message

            let allAnswered = true;

            // Parcourir les questions
            ['q1', 'q2', 'q5'].forEach(question => {
                const radios = form.elements[question];
                let answered = false;

                for (let i = 0; i < radios.length; i++) {
                    if (radios[i].checked) {
                        answered = true;
                        break;
                    }
                }

                if (!answered) {
                    allAnswered = false;
                }
            });

            if(!age_question.value) {
                allAnswered = false;
            }

            if (!allAnswered) {
                alertMessage.textContent = "Veuillez répondre à toutes les questions.";
                return;
            }

            // Enregistrer le code utilisateur dans le local storage
            localStorage.setItem("user_test_code", document.getElementById('test-code').value);

            // Vérification du score total
            document.getElementById('form-qt').classList.add('hidden');
            showConditionsScreen();
        }

        function showConditionsScreen() {
            document.getElementById('condition-screen').classList.remove('hidden');

            let conditionText = "\nEnvironnement calme : Assurez-vous d'être dans un lieu exempt de distractions.\n\n Concentration exclusive : N'effectuez pas de prises de notes ni d'utilisation d'aides extérieures.\n\n Navigation web : Ne quittez pas la page de l'expérience sous peine d'annulation de participation.\n\n Durée : Prévoyez suffisamment de temps pour compléter l'expérience sans interruptions.\n\n Honnêteté : Soyez honnête dans vos réponses et actions, sans chercher à tromper les résultats.\n";

            document.getElementById('condition-text').innerText = conditionText;

            // Activer le bouton si les conditions sont acceptées
            document.getElementById('accept-conditions').addEventListener('change', function () {
                    document.getElementById('start-experiment').disabled = !this.checked;
            });
        }

        function launchExperiment() {
            document.getElementById('condition-screen').classList.add('hidden');
            document.getElementById('experiment-screen').classList.remove('hidden');
            // expOrder = shuffle(["visual", "motor"]);
            expOrder = [participant['MOVF'], participant['MOVN']];

            startTrial();  // Lancer le premier essai
            activateFullScreen();
            monitorFullScreenExit();

            let code = parseInt(currentTest);

            // Événement pour le mouvement de la souris
            document.addEventListener('mousemove', (event) => {
            if (isDrawing) {
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(event.clientX, event.clientY, 2, 0, Math.PI * 2);
                ctx.fill();

                // Calculer la vitesse du mouvement
                const currentTime = Date.now();
                if (lastMouseX !== null && lastMouseY !== null && lastMouseTime !== null) {
                    const deltaX = event.clientX - lastMouseX;
                    const deltaY = event.clientY - lastMouseY;
                    const distance = Math.sqrt(deltaX ** 2 + deltaY ** 2);
                    const timeDelta = currentTime - lastMouseTime;

                    const speed = distance / timeDelta; // Vitesse en pixels par milliseconde

                    // Condition lente
                    if (code === 2 && speed > 0.90) {
                        alertDiv.style.display = 'block'; // Affiche l'alerte
                        setTimeout(() => {
                            alertDiv.style.display = 'none'; // Cache après 1 secondes
                        }, 1000);
                    }
                }

                // Mettre à jour les dernières coordonnées et temps
                lastMouseX = event.clientX;
                lastMouseY = event.clientY;
                lastMouseTime = currentTime;
            }
        });
        }

        function startTrial() {
            if (trial > maxTrials) {
                document.getElementById('input-container').classList.remove('hidden');
                return; 
            }

            let counterTo = false;

            if (expOrder[0] === "visual" && trial - 1 < visualTrials + VtestTrials) {
                if(visualDone === 0) {
                    displayMessage(0);
                    counterTo = true;
                } 
            } else if (expOrder[0] === "visual" && trial > visualTrials + VtestTrials) {
                if(motorDone === 0) {
                    displayMessage(1);
                    counterTo = true;
                } 
            } else if (expOrder[0] === "motor" && trial - 1 < motorTrials + testTrials) {
                if(motorDone === 0) {
                    displayMessage(1);
                    counterTo = true;
                } 
            } else if (expOrder[0] === "motor" && trial > motorTrials + testTrials) {
                if(visualDone === 0) {
                    displayMessage(0);
                    counterTo = true;
                } 
            }

            
            if(!counterTo) {
                document.getElementById('countdown').innerText = "Préparez vous...";
                document.getElementById('countdown').classList.remove('hidden');

                setTimeout(() => {
                    if((
                        (expOrder[0] === 'visual' && visualDone < VtestTrials) 
                        || (expOrder[0] === 'motor' && motorDone < testTrials) 
                        || (expOrder[1] === 'motor' && motorDone < testTrials && visualDone >= VtestTrials + visualTrials) 
                        || (expOrder[1] === 'visual' && visualDone < VtestTrials && motorDone >= testTrials + motorTrials)) 
                        && document.getElementById('trial-number-training').classList.contains('hidden')) {
                        document.getElementById('trial-number-training').classList.remove('hidden');
                    }
                    document.getElementById('trial-number').innerText = "Essai " + trial + " sur " + maxTrials;
                    document.getElementById('experiment-screen').classList.add('container3');
                    document.getElementById('experiment-screen').classList.remove('container');
                    document.getElementById('minute-button').classList.add('hidden');  // Cacher le bouton avant chaque compte à rebours

                    startCountdown();
                }, 2000);
            }
        }

        function startCountdown() {
            let countdown = 3;  // Compte à rebours de 3 secondes avant chaque essai
            document.getElementById('countdown').innerText = countdown;
            document.getElementById('trial-number').classList.remove('hidden');
            
            countdownTimer = setInterval(() => {
                countdown--;
                document.getElementById('countdown').innerText = countdown;

                if (countdown === 0) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    clearInterval(countdownTimer);

                    if(!document.getElementById('trial-number-training').classList.contains('hidden')) {
                        document.getElementById('trial-number-training').classList.add('hidden');
                    }
                    
                    document.getElementById('experiment-screen').classList.remove('container3');
                    document.getElementById('experiment-screen').classList.add('container');

                    trialStartTime = Date.now();

                    runTrial();  // Lancer l'essai après le compte à rebours
                }
            }, 1000);
        }

        function validateInputs() {
            if(trial > maxTrials) {
                document.getElementById('input-container').classList.add('hidden');
                endExperiment();
                return;
            }

            const inputs = document.querySelectorAll('.number-input');
            let allFilled = true;

            inputs.forEach(input => {
                const value = input.value.trim();
                if (!value || isNaN(value)) {
                    allFilled = false;
                }
            });

            if (allFilled) {
                document.getElementById('input-container').classList.add('hidden');

                inputs.forEach(input => {
                    input.value = '';
                });
                
                document.getElementById('message_btn').classList.remove('hidden');
                document.getElementById('message_container').classList.remove('hidden');
            } else {
                alert('Veuillez remplir tous les champs avec des chiffres valides.');
            }
        }

        function validateMessage() {
            document.getElementById('message_btn').classList.add('hidden');
            document.getElementById('message_container').classList.add('hidden');

            $numbers = null;

            if(participant['MOVF'] === 'motor' && motorDone !== 0) {
                $numbers = participant['codeToGive2'];
            } else {
                if(participant['MOVF'] === 'visual' && visualDone !== 0) {
                    $numbers = participant['codeToGive2'];
                } else {
                    $numbers = participant['codeToGive1'];
                }
            }

            displayNumbers($numbers);

            document.getElementById('number-display').classList.remove('hidden');
        }

        function validateNumbers() {
            document.getElementById('number-display').classList.add('hidden');
            eraseNumbers();

            document.getElementById('countdown').innerText = "Préparez vous...";
            document.getElementById('countdown').classList.remove('hidden');

            setTimeout(() => {
                if((
                    (expOrder[0] === 'visual' && visualDone < VtestTrials) 
                    || (expOrder[0] === 'motor' && motorDone < testTrials) 
                    || (expOrder[1] === 'motor' && motorDone < testTrials && visualDone >= VtestTrials + visualTrials) 
                    || (expOrder[1] === 'visual' && visualDone < VtestTrials && motorDone >= testTrials + motorTrials)) 
                    && document.getElementById('trial-number-training').classList.contains('hidden')) {
                    document.getElementById('trial-number-training').classList.remove('hidden');
                }
                document.getElementById('trial-number').innerText = "Essai " + trial + " sur " + maxTrials;
                document.getElementById('experiment-screen').classList.add('container3');
                document.getElementById('experiment-screen').classList.remove('container');
                document.getElementById('minute-button').classList.add('hidden');  // Cacher le bouton avant chaque compte à rebours

                startCountdown();
            }, 2000);
        }

        // no === 0 --> vidéo / no === 1 --> moteur / currentTest === '1' ---> rapide / currentTest === '2' ---> lent
        function displayMessage(no) {
            const messageDiv = document.getElementById('messsage_bf_condition');
            const container = document.getElementById('message_container');

            let message = '';

            if(no === 0 && currentTest === '1') { // Vidéo rapide
                message = "Vous regarderez des vidéos où une souris atteint un cercle. Vous devrez observer ces vidéos et, lorsque vous estimerez qu'une minute s'est écoulée, cliquer sur le bouton vert \"Je pense que ça fait une minute\" en bas à droite.";
            } else if (no === 0 && currentTest === '2') { // Vidéo lent
                message = "Vous regarderez des vidéos où une souris atteint un cercle. Vous devrez observer ces vidéos et, lorsque vous estimerez qu'une minute s'est écoulée, cliquer sur le bouton vert \"Je pense que ça fait une minute\" en bas à droite.";
            } else if (no === 1 && currentTest === '1') { // Moteur rapide
                message = "Vous verrez des cercles noirs à l'écran et vous devrez atteindre chaque cercle le plus rapidement possible en utilisant la souris. Vous devrez continuer à atteindre les cercles jusqu'à ce que vous pensiez qu'une minute se soit écoulée, puis cliquer sur le bouton \"Je pense que ça fait une minute\" en bas à droite. Vous aurez 3 essais d'entraînement avant de commencer.";
            } else if (no === 1 && currentTest === '2') { // Moteur lent
                message = "Vous verrez des cercles noirs à l'écran et devrez atteindre chaque cercle lentement avec la souris, de manière à former une ligne entre les cercles. Vous devrez continuer à atteindre les cercles jusqu'à ce que vous pensiez qu'une minute se soit écoulée, puis cliquer sur le bouton \"Je pense que ça fait une minute\" en bas à droite. Vous aurez 3 essais d'entraînement avant de commencer.";
            }

            messageDiv.innerHTML = message;

            if((participant['MOVF'] === 'motor' && motorDone === testTrials + motorTrials && visualDone === 0)
            || (participant['MOVF'] === 'visual' && visualDone === VtestTrials + visualTrials && motorDone === 0)) {
                document.getElementById('input-container').classList.remove('hidden');
            } else {
                document.getElementById('message_btn').classList.remove('hidden');
                container.classList.remove('hidden');
            }
        }

        function runTrial() {
            document.getElementById('countdown').classList.add('hidden');
            document.getElementById('trial-number').classList.add('hidden');
            document.getElementById('minute-button').classList.remove('hidden');

            if (expOrder[0] === "visual" && trial - 1 < visualTrials + VtestTrials) {
                playVideoTrial();
                videoTrial = true;
                visualDone++;
            } else if (expOrder[0] === "visual" && trial > visualTrials + VtestTrials) {
                runCircleTrial();
                videoTrial = false;
                motorDone++;
            } else if (expOrder[0] === "motor" && trial - 1 < motorTrials + testTrials) {
                runCircleTrial();
                videoTrial = false;
                motorDone++;
            } else if (expOrder[0] === "motor" && trial > motorTrials + testTrials) {
                playVideoTrial();
                videoTrial = true;
                visualDone++;
            }
        }

        // Lancer le test avec le cercle qui apparait aléatoirement
        function runCircleTrial() {
            const grid = document.getElementById('circle-grid');
            grid.classList.remove('hidden');
            moveCircleRandomly(); // Déplace immédiatement le cercle
        }

        // Déplacer le cercle de façon aléatoire
        function moveCircleRandomly() {
            isDrawing = true;
            const circle = document.getElementById('circle');
            const randomX = Math.floor(Math.random() * 90); // Positionnement aléatoire dans la grille
            const randomY = Math.floor(Math.random() * 90);
            circle.style.top = `${randomY}%`;
            circle.style.left = `${randomX}%`;
            circle.style.visibility = 'visible';

            // Attendre que l'utilisateur survole le cercle
            circle.onmouseenter = () => {
                isDrawing = false;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                circle.style.visibility = 'hidden';
                setTimeout(moveCircleRandomly, 500); // Attendre 0.5s avant de déplacer
            };
        }

        function playVideoTrial() {
            const videoElement = document.getElementById('experiment-video');
            
            if(currentTest == "2") {
                videoElement.src = videosLentes[videoIndex]
            } else {
                videoElement.src = videos[videoIndex];
            }

            videoElement.classList.remove('hidden');
            videoElement.play();

            videoElement.onended = () => {
                endTrial();  // Terminer l'essai automatiquement quand la vidéo se termine
            };
        }

        function endTrial() {
            clearTimeout(trialTimer);  // Arrêter l'essai en cours

            trial++;

            if(videoTrial) {
                const videoElement = document.getElementById('experiment-video');
                videoElement.classList.add('hidden');
                videoElement.pause();
                videoIndex++;  // Passer à la vidéo suivante
            } else {
                const circle = document.getElementById('circle');
                circle.style.visibility = 'hidden';
            }

            isDrawing = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Calcul durée de l'essai
            trialEndTime = Date.now();
            trialDurations.push(trialEndTime - trialStartTime);  // Durée en millisecondes

            document.getElementById('minute-button').classList.add('hidden');  // Cacher le bouton après l'essai

            startTrial();
        }

        function endExperiment() {
            sendEmail();
            localStorage.setItem("user_test_code", document.getElementById('test-code').value);
            clearInterval(countdownTimer);
            clearTimeout(trialTimer);
            clearTimeout(betweenTrialsTimer);
        }

        function activateFullScreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { // Firefox
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { // Chrome, Safari, Opera
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { // IE/Edge
                element.msRequestFullscreen();
            }
        }

        function monitorFullScreenExit() {
            document.addEventListener('fullscreenchange', exitFullScreenHandler);
            document.addEventListener('webkitfullscreenchange', exitFullScreenHandler);
            document.addEventListener('mozfullscreenchange', exitFullScreenHandler);
            document.addEventListener('MSFullscreenChange', exitFullScreenHandler);
        }

        function exitFullScreenHandler() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                alert("Vous avez quitté le plein écran. L'expérience est terminée.");
                location.reload();  // Recharge la page pour recommencer
            }
        }

        function sendEmail() {
            let testCondition = currentTest === '1' ? 'rapide ' : 'lente '
            let order = expOrder[0] === 'visuel' ? '(Entraînement Visuel > Visuel > Entraînement Moteur > Moteur)\n\n' : '(Entraînement Moteur > Moteur > Entraînement Visuel > Visuel)\n\n'
            let formattedResults = "Condition " + testCondition + order;
            let trouble1 = document.getElementById('trouble1');
            let trouble2 = document.getElementById('trouble2');

            if ((trouble1 && trouble1.value) || trouble2 && trouble2.value) {
                formattedResults += "ATTENTION, CETTE PERSONNE A CES TROUBLES : ";

                if (trouble1 && trouble1.value) {
                    formattedResults += trouble1.value + " ";
                }

                if (trouble2 && trouble2.value) {
                    formattedResults += trouble2.value + " ";
                }
                formattedResults += "\n\n";
            }

            let trialsTimes = [];
            let VtrialsTimes = [];
            let motorsTimes = [];
            let visualsTimes = [];

            const selectedOption = document.querySelector('input[name="q5"]:checked');

            let result = "";
            if (selectedOption) {
                result = selectedOption.value;
            }

            formattedResults += "Participant n°" + document.getElementById('test-code').value + " : " + result + " de " + document.getElementById('age_question').value + 'ans\n\n';

            let count = 0;

            if(expOrder[0] === 'visual') {
                formattedResults += "Visuel \n";
                for (let i = count; i < visualTrials + VtestTrials; i++) {
                    let duration = trialDurations[i];
                    if (i < VtestTrials) {
                        VtrialsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} (Entrainement) : ${duration} millisecondes\n`;
                    } else {
                        visualsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} : ${duration} millisecondes\n`;
                    }
                }
                count = VtestTrials + visualTrials;

                formattedResults += "\nMoteur \n";

                for (let i = count; i < testTrials + motorTrials + count; i++) {
                    let duration = trialDurations[i];
                    if (i < testTrials + count) {
                        trialsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} (Entrainement) : ${duration} millisecondes\n`;
                    } else {
                        motorsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} : ${duration} millisecondes\n`;
                    }
                }
            } else if(expOrder[0] === 'motor') {
                formattedResults += "Moteur \n";

                for (let i = count; i < testTrials + motorTrials; i++) {
                    let duration = trialDurations[i];
                    if (i < testTrials) {
                        trialsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} (Entrainement) : ${duration} millisecondes\n`;
                    } else {
                        motorsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} : ${duration} millisecondes\n`;
                    }
                }

                count = testTrials + motorTrials;

                formattedResults += "\nVisuel \n";
                for (let i = count; i < visualTrials + VtestTrials + count; i++) {
                    let duration = trialDurations[i];
                    if (i < VtestTrials + count) {
                        VtrialsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} (Entrainement) : ${duration} millisecondes\n`;
                    } else {
                        visualsTimes.push(duration);
                        formattedResults += `Essai ${i + 1} : ${duration} millisecondes\n`;
                    }
                }
            }

            formattedResults += "\n\nRécapitulatif des données : " + generateResultsLink(motorsTimes, visualsTimes, trialsTimes, VtrialsTimes);

            document.getElementById('countdown').classList.add('hidden');

            const load_spinners = document.getElementsByClassName("load-spinner");
            for (let i = 0; i < load_spinners.length; i++) {
                load_spinners.item(i).classList.remove('hidden');
            }

            emailjs.send("service_p9brh5z", "template_5zjx1a2", {
                message: formattedResults // message : le texte formaté
            }).then((response) => {
                document.getElementById('countdown').innerText = "Expérience terminée, merci de votre participation.";
            }).catch((error) => {
                document.getElementById('countdown').innerText = "Échec de l'envoi des données de l'expérience. Pourriez-vous fournir ceci à votre coordinateur ? Merci ! ";
            }).finally(() => {
                // Cache l'animation
                for (let i = 0; i < load_spinners.length; i++) {
                    load_spinners.item(i).classList.add('hidden');
                }
                document.getElementById('countdown').classList.remove('hidden');
            });
        }

        function generateResultsLink(motors, visuals, trials, Vtrials) {
            const motorsEncoded = encodeURIComponent(JSON.stringify(motors));
            const visualsEncoded = encodeURIComponent(JSON.stringify(visuals));
            const trialsEncoded = encodeURIComponent(JSON.stringify(trials));
            const VtrialsEncoded = encodeURIComponent(JSON.stringify(Vtrials));
            const speed = currentTest === "1" ? 'rapide' : 'lente';
            
            const basePath = "Axphyr.github.io/pages/Tests/results/index.html";

            // Construction de l'URL
            const url = `${basePath}?motors=${motorsEncoded}&visuals=${visualsEncoded}&trials=${trialsEncoded}&Vtrials=${VtrialsEncoded}&speed=${speed}`;
            
            return url;
        }
    </script>
</body>
</html>
